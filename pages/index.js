import Head from "next/head";
import React, { useState, useEffect } from "react";
import styles from "../styles/Home.module.css";
import Header from "../comps/Header";
import Footer from "../comps/Footer";
import _ from "lodash";
import Box from "@mui/material/Box";
import InputLabel from "@mui/material/InputLabel";
import MenuItem from "@mui/material/MenuItem";
import FormControl from "@mui/material/FormControl";
import Select from "@mui/material/Select";

export default function Home() {
  const [fetchedData, setFetchedData] = useState([]);
  const [currentlyOpenedModule, setCurrentlyOpenedModule] = useState();
  const [moduleKeys, setModuleKeys] = useState([]);
  const [sortBy, setSortBy] = useState();
  const [entriesMarkedAsFinished, setEntriesMarkedAsFinished] = useState({
    movies: [],
    games: [],
    books: [],
    comics: [],
    series: [],
  });

  useEffect(() => {
    let btns = document.getElementsByClassName("navbtn");
    for (const btn of btns) {
      btn.style.color = "white";
    }

    if (currentlyOpenedModule)
      document.getElementById(currentlyOpenedModule).style.color = "#ffe81f";
  }, [currentlyOpenedModule]);

  function displayData(e) {
    setCurrentlyOpenedModule(e.target.id);
    fetchData(e.target.id);
  }

  function fetchData(target) {
    fetch("./data/" + target + ".json")
      .then((response) => response.json())
      .then((data) => {
        setFetchedData(data);
        setModuleKeys(Object.keys(data[0]));
      });
  }

  function orderBy(event, order = "asc") {
    setFetchedData(_.orderBy(fetchedData, event.target.value, order));
  }

  function toggleEntryAsFinished(event, entry) {
    const currentTitle = entry.title.replace(/\s+/g, "-").toLowerCase();
    const isEntryFinished =
      entriesMarkedAsFinished[currentlyOpenedModule].includes(currentTitle);

    if (isEntryFinished) {
      const arrWithoutEntry = _.without(
        entriesMarkedAsFinished[currentlyOpenedModule],
        currentTitle
      );

      setEntriesMarkedAsFinished({
        ...entriesMarkedAsFinished,
        [currentlyOpenedModule]: arrWithoutEntry,
      });
    }

    if (!isEntryFinished) {
      setEntriesMarkedAsFinished({
        ...entriesMarkedAsFinished,
        [currentlyOpenedModule]: [
          ...entriesMarkedAsFinished[currentlyOpenedModule],
          currentTitle,
        ],
      });
    }
  }
  return (
    <div className={styles.appcontainer}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Header displayData={displayData} />

      <div className={styles.viewerContainer}>
        <div id={styles.viewer}>
          {fetchedData.length ? (
            <div id={styles.sortContainer}>
              <button>Filters</button>
              <Box sx={{ marginLeft: "auto" }}>
                <FormControl sx={{ width: "200px" }}>
                  <InputLabel>Sort By</InputLabel>
                  <Select value={sortBy} label="Sort By" onChange={orderBy}>
                    {moduleKeys.map((key) => {
                      <MenuItem value={key}>
                        {key
                          .replace(/([A-Z])/g, " $1")
                          .replace(/^./, function (str) {
                            return str.toUpperCase();
                          })}
                      </MenuItem>;
                    })}
                  </Select>
                </FormControl>
              </Box>
            </div>
          ) : null}
          <div id={styles.moduleContainer}>
            {fetchedData.map((e1, i1) => {
              let currentTitle = e1.title.replace(/\s+/g, "-").toLowerCase();
              return (
                <div
                  className={
                    entriesMarkedAsFinished[currentlyOpenedModule].includes(
                      currentTitle
                    )
                      ? styles.cardFinished
                      : styles.cardUnfinished
                  }
                  id={currentTitle + "-card"}
                  key={"1" + i1}
                >
                  {moduleKeys.map((e2, i2) => {
                    let currentKey = moduleKeys[i2];
                    let currentValue = e1[currentKey];
                    return (
                      <div key={"2" + i2}>
                        {currentKey === "coverImage" ? (
                          <div className={styles.coverImageContainer}>
                            <img
                              className={styles.coverImage}
                              src={currentValue}
                            />
                          </div>
                        ) : currentKey === "links" ? (
                          <div className={styles.linksContainer}>
                            {Object.keys(currentValue).map((e3, i3) => {
                              return (
                                <a
                                  href={currentValue[e3].link}
                                  key={"3" + i3}
                                  rel="nofollow noopener"
                                >
                                  <img
                                    src={currentValue[e3].icon}
                                    style={{
                                      width: "35px",
                                      aspectRatio: "1/1",
                                      objectFit: "cover",
                                      margin: "10px",
                                      padding: "5px",
                                    }}
                                  />
                                </a>
                              );
                            })}
                          </div>
                        ) : currentKey === "isCanon" ? null : (
                          <h2>{currentKey.replace(/([A-Z])/g, " $1")}:</h2>
                        )}
                        {typeof currentValue === "string" &&
                        currentKey !== "coverImage" ? (
                          <p>{currentValue}</p>
                        ) : null}
                        {currentKey === "isCanon" ? (
                          currentValue ? (
                            <div className={styles.canonDiv}>
                              <h3 className={styles.canon}>Canon</h3>
                            </div>
                          ) : (
                            <div className={styles.legendsDiv}>
                              <h3 className={styles.legends}>Legends</h3>
                            </div>
                          )
                        ) : null}
                      </div>
                    );
                  })}
                  <button
                    onClick={(e) => toggleEntryAsFinished(e, e1)}
                    className={styles.finishedBtn}
                    id={e1.title.replace(/\s+/g, "-").toLowerCase() + "btn"}
                  >
                    {entriesMarkedAsFinished[currentlyOpenedModule].includes(
                      currentTitle
                    )
                      ? "Mark as Unfinished"
                      : "Mark as Finished"}
                  </button>
                </div>
              );
            })}
          </div>
        </div>
      </div>
      <Footer />
    </div>
  );
}
